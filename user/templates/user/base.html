<!DOCTYPE html>
{% load static %}

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Firefly</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.7.2/css/all.css"
      integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="{% static 'css/main.css' %}" />
    <meta name="vapid-key" content="{{ vapid_key }}">
    {% if user.id %}
        <meta name="user_id" content="{{ user.id }}">
    {% endif %}
  </head>

  <body>
    <header>
     
      <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo01" aria-controls="navbarTogglerDemo01" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
          <a class="navbar-brand" href="{% url 'user-home'%}">FireFly</a>
            
          <div
            class="collapse navbar-collapse justify-content-end"  id="navbarTogglerDemo01"
            id="navbarSupportedContent"
          >
            <ul class="navbar-nav mb-2 mb-lg-0">
              <li class="nav-item">
                <a
                  class="nav-link"
                  aria-current="page"
                  href="{% url 'user-home'%}"
                  >Home</a
                >
              </li>
              {% if user.is_authenticated %}
             

              <li class="nav-item">
                <a class="nav-link" href="{%url 'logout'%}">Logout</a>
              </li>
              {%else%}
              <li class="nav-item">
                <a class="nav-link" href="{%url 'register'%}">Register</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{%url 'login'%}">Login</a>
              </li>
              {% endif %}
            </ul>
          </div>
       
      </nav>
    </header>
    <br /><br />
    <main>
      {% if messages %} {% for message in messages %}

      <div class="alert alert-{{message.tags}}">{{message}}</div>
      {% endfor %} {% endif %}

      {% block content %}


       {% endblock content %}
    </main>





    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript">
    </script>
     <script type = "text/javascript" language = "javascript">
     var mqtt;
     var reconnectTimeout = 2000;
     var host="mr-connection-pi5rgecxa7b.messaging.solace.cloud"; //change this
    //  var host="pi2.local"; //change this
     //var host="m21.cloudmqtt.com";
     //var host="test.mosquitto.org"; //change this
     //var host="iot.eclipse.org";
     var port=8883;
     //var port =8081;
     //r port=37363;
     //var port=443;
     
      function onConnect() {
   
     console.log("Connected ");
     mqtt.subscribe("STEM/1/CRX-401/student");
     message = new Paho.MQTT.Message("Hello World");
     message.destinationName = "STEM/1/CRX-401/student";
     mqtt.send(message);
     }
     function MQTTconnect() {
     console.log("connecting to "+ host +" "+ port);
       var x=Math.floor(Math.random() * 10000); 
     var cname="orderform-"+x;
     mqtt = new Paho.MQTT.Client(host,port,cname);
     //document.write("connecting to "+ host);
     var options = {
       useSSL:true,
       timeout: 3,
       userName:"solace-cloud-client",
       password:"chhe5o2afe2pdvu66oj6tgd05k",
       onSuccess: onConnect
       
       
      };
      
     mqtt.connect(options); //connect
     }
    
     </script> -->
     <!-- 
     -->
     <!-- <script src="https://unpkg.com/mqtt@3.0.0/dist/mqtt.min.js"></script>
<script>
const host = 'mr-connection-pi5rgecxa7b.messaging.solace.cloud'
const port = '8443'
const clientId = `mqtt_${Math.random().toString(16).slice(3)}`

const connectUrl = `mqtt://${host}:${port}`
const client = mqtt.connect(connectUrl, {
  clientId,
  clean: true,
  connectTimeout: 4000,
  username: 'solace-cloud-client',
  password: 'chhe5o2afe2pdvu66oj6tgd05k',
  reconnectPeriod: 1000,
})

const topic = 'STEM/1/CRX-401/student'
client.on('connect', () => {
  console.log('Connected')
  client.subscribe([topic], () => {
    console.log(`Subscribe to topic '${topic}'`)
  })
  client.publish(topic, 'nodejs mqtt test', { qos: 0, retain: false }, (error) => {
    if (error) {
      console.error(error)
    }
  })
})
client.on('message', (topic, payload) => {
  console.log('Received Message:', topic, payload.toString())
})
</script> -->
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>


<script>


const options = {
    userName: 'solace-cloud-client',
    password: 'chhe5o2afe2pdvu66oj6tgd05k',
    useSSL: true,
    onSuccess: onConnect,
    onFailure: onFailure,
  }
  
  const connectUrl = 'mr-connection-pi5rgecxa7b.messaging.solace.cloud';
  const client = new Paho.MQTT.Client(connectUrl, 8443, "new-id");
  client.connect(options);
  
  function onConnect() {
    console.log("Connected");
    client.subscribe("STEM/1/CRX-401/student", onMessageArrived);
  }
  
  function onMessageArrived(message) {
    console.log("Message arrived: " + message.payloadString);
    Notification.requestPermission().then(perm=>{
      if(perm==="granted"){
        new Notification("Please update your emergency status", {
          body:"http://localhost:8000/respond",
        })
      }
    })
  }

  
  function onFailure() {
    console.log("Not working!!");
  }
  
  


</script> -->






<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.2/mqttws31.min.js"></script>
<script type="text/javascript">
  
$.ajaxSetup({
  beforeSend: function(xhr, settings) {
    xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
  }
});


    // Connect to Solace MQTT broker

    var clientId = "clientId-" + {{ user.id }};
    var client = new Paho.MQTT.Client('mr-connection-pi5rgecxa7b.messaging.solace.cloud', 8443, clientId);
    client.onConnectionLost = onConnectionLost;
    client.onMessageArrived = onMessageArrived;
    client.connect({
        userName: 'solace-cloud-client',
        password: 'chhe5o2afe2pdvu66oj6tgd05k',
        useSSL: true,
        onSuccess: onConnect,
        onFailure: onFailure
    });

    function onConnect() {
        console.log('Connected to Solace MQTT broker');
        // Subscribe to topic
        client.subscribe('STEM/1/CRX-401/student');
    }

    function onConnectionLost(responseObject) {
        console.log('Connection lost: ' + responseObject.errorMessage);
    }

    function onMessageArrived(message) {
        console.log('Message arrived: Topic: ' + message.destinationName + ', Payload: ' + message.payloadString);
        // Display the alert to the user
        var response = confirm(message.payloadString + ": yes or no");
        sendResponse(response)
    }

    function sendResponse(response) {
  $.ajax({
    type: "POST",
    url: "get_response",
    data: {
      response: response,
      csrfmiddlewaretoken: '{{ csrf_token }}'
    },
    success: function (data) {
      alert("Please don't panic. Everything will be alright!")
      window.location.href="http://localhost:8000/success"
      console.log("Response sent successfully");
    },
    error: function (data) {
      console.log("Error sending response");
    }
  });
}

    function onFailure(invocationContext, errorCode, errorMessage) {
        console.log('Connection failed: ' + errorMessage);
    }
</script>



<!-- 
<script src="https://unpkg.com/mqtt@3.0.0/dist/mqtt.min.js"></script>
<script>
const host = 'mr-connection-pi5rgecxa7b.messaging.solace.cloud'
const port = '8883'
const clientId = `mqtt_${Math.random().toString(16).slice(3)}`

const connectUrl = `mqtt://${host}:${port}`
const client = mqtt.connect(connectUrl, {
  clientId,
  useSSL:true,
  clean: true,
  connectTimeout: 4000,
  username: 'solace-cloud-client',
  password: 'chhe5o2afe2pdvu66oj6tgd05k',
  reconnectPeriod: 1000,
})

const topic = 'STEM/1/CRX-401/student'
client.on('connect', () => {
  console.log('Connected')
  client.subscribe([topic], () => {
    console.log(`Subscribe to topic '${topic}'`)
  })
})

client.on('message', (topic, payload) => {
  console.log('Received Message:', topic, payload.toString())
})
</script>


   -->


<!-- 
   <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>


<script>

  
  var factoryProps = new solace.SolclientFactoryProperties();
factoryProps.profile = solace.SolclientFactoryProfiles.version10;
solace.SolclientFactory.init(factoryProps);

solace.SolclientFactory.setLogLevel(solace.LogLevel.DEBUG);
subscriber.session = solace.SolclientFactory.createSession({
    // solace.SessionProperties
    url:     "mr-connection-pi5rgecxa7b.messaging.solace.cloud",
    userName: "solace-cloud-client",
    password: "chhe5o2afe2pdvu66oj6tgd05k",
});
// define session event listeners
    /*...see section Session Events...*/
// define message event listener
    /*...see section Receiving a message...*/
// connect the session
try {
    subscriber.session.connect();
} catch (error) {
    subscriber.log(error.toString());
}

subscriber.session.on(solace.SessionEventCode.MESSAGE, function (message) {
    subscriber.log('Received message: "' + message.getBinaryAttachment() + '", details:\n' + message.dump());
});


subscriber.subscribe = function () {
    try {
        subscriber.session.subscribe(
            solace.SolclientFactory.createTopic("STEM/1/CRX-401/student"),
            true,
            "STEM/1/CRX-401/student",
            10000
        );
    } catch (error) {
        subscriber.log(error.toString());
    }
}
</script>
    -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
      integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
      crossorigin="anonymous"
    ></script>
    
  </body>
</html>
